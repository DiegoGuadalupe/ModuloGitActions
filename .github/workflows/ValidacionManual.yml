name: âš™ï¸ VerificaciÃ³n Manual (Terraform, Ansible & Shell Script)

# Permite ejecutar este workflow manualmente desde la interfaz de GitHub
on:
  workflow_dispatch:
    inputs:
      terraform_dir:
        description: 'Directorio que contiene los archivos .tf (Terraform)'
        required: true
        default: 'Terraform'

jobs:
  validate-code:
    runs-on: ubuntu-latest
    
    # Define variables de entorno para las credenciales de AWS
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}

    steps:
    - name: â¬‡ï¸ Checkout del CÃ³digo
      uses: actions/checkout@v4

    # ----------------------------------------
    # VALIDACIÃ“N DEL SCRIPT DEPLOY.SH
    # ----------------------------------------
    - name: âš™ï¸ Establecer Permisos de EjecuciÃ³n para deploy.sh
      # La ruta absoluta a deploy.sh desde la raÃ­z del repo.
      run: chmod +x deploy.sh
    
    - name: ğŸ” VerificaciÃ³n de Sintaxis de Shell Script
      # Usa 'bash -n' para comprobar errores de sintaxis sin ejecutar el script
      run: bash -n deploy.sh

    # ----------------------------------------
    # VALIDACIÃ“N DE TERRAFORM
    # ----------------------------------------
    - name: âš™ï¸ Configurar Terraform
      uses: hashicorp/setup-terraform@v3
      with:
       terraform_version: "1.13.5"

    - name: ğŸ”„ Inicializar Terraform
      run: terraform init
      working-directory: ${{ inputs.terraform_dir }}

    - name: ğŸ” Validar Formato y Sintaxis de Terraform
      run: terraform fmt -check && terraform validate
      working-directory: ${{ inputs.terraform_dir }}

    - name: ğŸ“ Terraform Plan (VerificaciÃ³n)
      # Esto verifica que el cÃ³digo es vÃ¡lido y las credenciales de AWS funcionan
      run: terraform plan -no-color
      working-directory: ${{ inputs.terraform_dir }}


    # ----------------------------------------
    # VALIDACIÃ“N DE ANSIBLE
    # ----------------------------------------
    - name: âš™ï¸ Configurar Python y Ansible
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: ğŸ› ï¸ Instalar Ansible y dependencias
      run: |
        pip install ansible
        ansible-galaxy collection install amazon.aws

    - name: ğŸ” Validar Sintaxis de Playbooks de Ansible
      # La ruta absoluta a Ansiblenginx.yml desde la raÃ­z del repo.
      run: ansible-playbook -i InventarioVacio.yml --syntax-check Ansible/nginx.yml
